<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/createExcel.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/createExcel.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import ExcelJS from 'exceljs'
import { saveAs } from 'file-saver'

/**
 * Formatea cualquier valor de fecha (Date, Timestamp de Firestore o string) a un string legible.
 * @param {Date|{toDate: Function}|string|null} dateObj
 * @returns {string}
 */
const formatDate = (dateObj) => {
  if (!dateObj) return ''

  // Si es un timestamp de Firestore
  if (dateObj &amp;&amp; typeof dateObj.toDate === 'function') {
    dateObj = dateObj.toDate()
  }

  // Si es una fecha válida
  if (dateObj instanceof Date) {
    return dateObj.toLocaleDateString()
  }

  return String(dateObj)
}

/**
 * Devuelve una etiqueta legible para estados de socios.
 * @param {'approved'|'rejected'|'pending'|string} status
 * @returns {string}
 */
const getStatusText = (status) => {
  switch (status) {
    case 'approved':
      return 'Alta'
    case 'rejected':
      return 'Baja'
    case 'pending':
    default:
      return 'Pendiente'
  }
}

/**
 * Crea una hoja de Excel basada en una colección homogénea de objetos.
 * @param {ExcelJS.Workbook} workbook
 * @param {string} sheetName
 * @param {Array&lt;Object>} data
 * @returns {void}
 */
const appendSheetFromData = (workbook, sheetName, data = []) => {
  if (!data || data.length === 0) return

  const worksheet = workbook.addWorksheet(sheetName)
  const columnKeys = Array.from(
    data.reduce((keys, row) => {
      Object.keys(row || {}).forEach((key) => keys.add(key))
      return keys
    }, new Set())
  )

  worksheet.columns = columnKeys.map((key) => ({
    header: key,
    key,
    width: Math.min(40, Math.max(10, key.length + 2)),
  }))

  data.forEach((row) => {
    const normalizedRow = {}
    columnKeys.forEach((key) => {
      normalizedRow[key] = row?.[key] ?? ''
    })
    worksheet.addRow(normalizedRow)
  })
}

/**
 * Exporta los datos de un socio a un libro Excel con pestañas para datos personales y pagos.
 *
 * @param {Object} partner
 * @param {Object|null} activeSeason
 * @param {Object|null} payments
 * @param {Array&lt;Object>} history
 * @param {function(Object): Promise&lt;void>} showPopupFn
 * @param {function(string, string=): string} tFn
 * @param {string} viewDictionary
 * @returns {Promise&lt;void>}
 */
export const exportPartnerToExcel = async (
  partner,
  activeSeason,
  payments,
  history,
  showPopupFn,
  tFn,
  viewDictionary
) => {
  if (!partner) return

  try {
    // 1. Información personal
    const personalInfo = {
      ID: partner.id,
      Nombre: partner.name || '',
      Apellidos: partner.lastName || '',
      Email: partner.email || '',
      DNI: partner.dni || '',
      Teléfono: partner.phone || '',
      Dirección: partner.address || '',
      IBAN: partner.accountNumber || '',
      'Fecha de nacimiento': formatDate(partner.birthDate) || '',
      Estado: getStatusText(partner.status),
      'Fecha de registro': formatDate(partner.createdAt) || '',
    }

    // 2. Pagos de temporada actual
    let currentPayments = []
    if (payments) {
      currentPayments.push({
        Temporada: payments.seasonYear,
        Fracción: 'Primera',
        Estado: payments.firstPayment ? 'Pagado' : 'Pendiente',
        Importe: payments.firstPaymentPrice || 0,
        'Fecha de pago': formatDate(payments.firstPaymentDate) || '',
      })

      if (payments.secondPaymentPrice > 0) {
        currentPayments.push({
          Temporada: payments.seasonYear,
          Fracción: 'Segunda',
          Estado: payments.secondPayment ? 'Pagado' : 'Pendiente',
          Importe: payments.secondPaymentPrice || 0,
          'Fecha de pago': formatDate(payments.secondPaymentDate) || '',
        })
      }

      if (payments.thirdPaymentPrice > 0) {
        currentPayments.push({
          Temporada: payments.seasonYear,
          Fracción: 'Tercera',
          Estado: payments.thirdPayment ? 'Pagado' : 'Pendiente',
          Importe: payments.thirdPaymentPrice || 0,
          'Fecha de pago': formatDate(payments.thirdPaymentDate) || '',
        })
      }
    }

    // 3. Historial de pagos
    let paymentHistoryData = []
    if (history &amp;&amp; history.length > 0) {
      history.forEach((payment) => {
        if (payment.firstPaymentPrice > 0) {
          paymentHistoryData.push({
            Temporada: payment.seasonYear,
            Fracción: 'Primera',
            Estado: payment.firstPayment ? 'Pagado' : 'Pendiente',
            Importe: payment.firstPaymentPrice || 0,
            'Fecha de pago': formatDate(payment.firstPaymentDate) || '',
          })
        }

        if (payment.secondPaymentPrice > 0) {
          paymentHistoryData.push({
            Temporada: payment.seasonYear,
            Fracción: 'Segunda',
            Estado: payment.secondPayment ? 'Pagado' : 'Pendiente',
            Importe: payment.secondPaymentPrice || 0,
            'Fecha de pago': formatDate(payment.secondPaymentDate) || '',
          })
        }

        if (payment.thirdPaymentPrice > 0) {
          paymentHistoryData.push({
            Temporada: payment.seasonYear,
            Fracción: 'Tercera',
            Estado: payment.thirdPayment ? 'Pagado' : 'Pendiente',
            Importe: payment.thirdPaymentPrice || 0,
            'Fecha de pago': formatDate(payment.thirdPaymentDate) || '',
          })
        }
      })
    }

    const workbook = new ExcelJS.Workbook()
    appendSheetFromData(workbook, 'Datos Personales', [personalInfo])
    appendSheetFromData(workbook, 'Pagos Actuales', currentPayments)
    appendSheetFromData(workbook, 'Historial de Pagos', paymentHistoryData)

    const excelBuffer = await workbook.xlsx.writeBuffer()

    // Crear un blob
    const blob = new Blob([excelBuffer], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8',
    })

    // Guardar el archivo
    saveAs(
      blob,
      `socio_${partner.name}_${partner.lastName}_${new Date().toISOString().split('T')[0]}.xlsx`
    )

    // Mostrar mensaje de éxito
    await showPopupFn({
      title: tFn(
        `${viewDictionary}.exportSuccessTitle`,
        'Exportación completada'
      ),
      text: tFn(
        `${viewDictionary}.exportSuccessText`,
        'Los datos del socio se han exportado correctamente.'
      ),
      icon: 'success',
      confirmButtonText: tFn('components.buttons.confirm', 'Aceptar'),
      confirmButtonColor: '#8be484',
    })
  } catch (error) {
    await showPopupFn({
      title: tFn(`${viewDictionary}.errorPopup.title`, 'Error'),
      text: tFn(
        `${viewDictionary}.errorPopup.exportError`,
        'Ha ocurrido un error al exportar los datos del socio.'
      ),
      icon: 'error',
      confirmButtonText: tFn('components.buttons.confirm', 'Aceptar'),
      confirmButtonColor: '#a3a3a3',
    })
  }
}

/**
 * Exporta a Excel la información agregada de todos los socios aprobados y su historial de pagos.
 *
 * @param {Array&lt;Object>} partners
 * @param {Object|null} activeSeason
 * @param {function(string, (string|number)): Promise&lt;Object|null>} getPartnerPaymentsForSeason
 * @param {function(string, (string|number)): Promise&lt;Array&lt;Object>>} getPartnerPaymentHistory
 * @param {function(Object): Promise&lt;void>} showPopupFn
 * @param {function(string, string=): string} tFn
 * @param {string} viewDictionary
 * @returns {Promise&lt;void>}
 */
export const exportAllPartnersToExcel = async (
  partners,
  activeSeason,
  getPartnerPaymentsForSeason,
  getPartnerPaymentHistory,
  showPopupFn,
  tFn,
  viewDictionary
) => {
  if (!partners || partners.length === 0) return

  try {
    // Crear lista de datos básicos de socios
    const partnersData = partners.map((partner) => ({
      ID: partner.id,
      Nombre: partner.name || '',
      Apellidos: partner.lastName || '',
      Email: partner.email || '',
      DNI: partner.dni || '',
      Teléfono: partner.phone || '',
      Dirección: partner.address || '',
      IBAN: partner.accountNumber || '',
      'Fecha de nacimiento': formatDate(partner.birthDate) || '',
      Estado: getStatusText(partner.status),
      'Fecha de registro': formatDate(partner.createdAt) || '',
    }))

    // Crear lista de pagos actuales para socios aprobados
    let allCurrentPayments = []
    let allPaymentHistory = []

    if (activeSeason &amp;&amp; partners.length > 0) {
      // Obtener los pagos de cada socio aprobado
      for (const partner of partners) {
        // Pagos de temporada actual
        const payments = await getPartnerPaymentsForSeason(
          partner.id,
          activeSeason.seasonYear
        )

        if (payments) {
          // Añadir primera fracción
          allCurrentPayments.push({
            'ID Socio': partner.id,
            Nombre: partner.name,
            Apellidos: partner.lastName,
            Temporada: payments.seasonYear,
            Fracción: 'Primera',
            Estado_pagos: payments.firstPayment ? 'Pagado' : 'Pendiente',
            Estado_socio: partner.status === 'approved' ? 'Alta' : 'Baja',
            Importe: payments.firstPaymentPrice || 0,
            'Fecha de pago': formatDate(payments.firstPaymentDate) || '',
          })

          // Añadir segunda fracción si existe
          if (payments.secondPaymentPrice > 0) {
            allCurrentPayments.push({
              'ID Socio': partner.id,
              Nombre: partner.name,
              Apellidos: partner.lastName,
              Temporada: payments.seasonYear,
              Fracción: 'Segunda',
              Estado_pagos: payments.secondPayment ? 'Pagado' : 'Pendiente',
              Estado_socio: partner.status === 'approved' ? 'Alta' : 'Baja',
              Importe: payments.secondPaymentPrice || 0,
              'Fecha de pago': formatDate(payments.secondPaymentDate) || '',
            })
          }

          // Añadir tercera fracción si existe
          if (payments.thirdPaymentPrice > 0) {
            allCurrentPayments.push({
              'ID Socio': partner.id,
              Nombre: partner.name,
              Apellidos: partner.lastName,
              Temporada: payments.seasonYear,
              Fracción: 'Tercera',
              Estado_pagos: payments.thirdPayment ? 'Pagado' : 'Pendiente',
              Estado_socio: partner.status === 'approved' ? 'Alta' : 'Baja',
              Importe: payments.thirdPaymentPrice || 0,
              'Fecha de pago': formatDate(payments.thirdPaymentDate) || '',
            })
          }
        }

        // Historial de pagos
        const history =
          (await getPartnerPaymentHistory(
            partner.id,
            activeSeason.seasonYear
          )) || []

        if (history.length > 0) {
          for (const payment of history) {
            // Primera fracción
            if (payment.firstPaymentPrice > 0) {
              allPaymentHistory.push({
                'ID Socio': partner.id,
                Nombre: partner.name,
                Apellidos: partner.lastName,
                Temporada: payment.seasonYear,
                Fracción: 'Primera',
                Estado_pagos: payment.firstPayment ? 'Pagado' : 'Pendiente',
                Estado_socio: partner.status === 'approved' ? 'Alta' : 'Baja',
                Importe: payment.firstPaymentPrice || 0,
                'Fecha de pago': formatDate(payment.firstPaymentDate) || '',
              })
            }

            // Segunda fracción
            if (payment.secondPaymentPrice > 0) {
              allPaymentHistory.push({
                'ID Socio': partner.id,
                Nombre: partner.name,
                Apellidos: partner.lastName,
                Temporada: payment.seasonYear,
                Fracción: 'Segunda',
                Estado_pagos: payment.secondPayment ? 'Pagado' : 'Pendiente',
                Estado_socio: partner.status === 'approved' ? 'Alta' : 'Baja',
                Importe: payment.secondPaymentPrice || 0,
                'Fecha de pago': formatDate(payment.secondPaymentDate) || '',
              })
            }

            // Tercera fracción
            if (payment.thirdPaymentPrice > 0) {
              allPaymentHistory.push({
                'ID Socio': partner.id,
                Nombre: partner.name,
                Apellidos: partner.lastName,
                Temporada: payment.seasonYear,
                Fracción: 'Tercera',
                Estado_pagos: payment.thirdPayment ? 'Pagado' : 'Pendiente',
                Estado_socio: partner.status === 'approved' ? 'Alta' : 'Baja',
                Importe: payment.thirdPaymentPrice || 0,
                'Fecha de pago': formatDate(payment.thirdPaymentDate) || '',
              })
            }
          }
        }
      }
    }

    const workbook = new ExcelJS.Workbook()
    appendSheetFromData(workbook, 'Socios', partnersData)
    appendSheetFromData(workbook, 'Pagos Actuales', allCurrentPayments)
    appendSheetFromData(workbook, 'Historial de Pagos', allPaymentHistory)

    const excelBuffer = await workbook.xlsx.writeBuffer()

    // Crear un blob
    const blob = new Blob([excelBuffer], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8',
    })

    // Guardar el archivo
    saveAs(
      blob,
      `listado_completo_socios_${new Date().toISOString().split('T')[0]}.xlsx`
    )

    // Mostrar mensaje de éxito
    await showPopupFn({
      title: tFn(
        `${viewDictionary}.exportAllSuccessTitle`,
        'Exportación completada'
      ),
      text: tFn(
        `${viewDictionary}.exportAllSuccessText`,
        'Los datos de todos los socios se han exportado correctamente.'
      ),
      icon: 'success',
      confirmButtonText: tFn('components.buttons.confirm', 'Aceptar'),
      confirmButtonColor: '#8be484',
    })
  } catch (error) {
    await showPopupFn({
      title: tFn(`${viewDictionary}.errorPopup.title`, 'Error'),
      text: tFn(
        `${viewDictionary}.errorPopup.exportAllError`,
        'Ha ocurrido un error al exportar los datos de los socios.'
      ),
      icon: 'error',
      confirmButtonText: tFn('components.buttons.confirm', 'Aceptar'),
      confirmButtonColor: '#a3a3a3',
    })
  }
}

export default exportPartnerToExcel
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#DynamicButton">DynamicButton</a></li><li><a href="global.html#DynamicInput">DynamicInput</a></li><li><a href="global.html#GalleryPage">GalleryPage</a></li><li><a href="global.html#PaginationControl">PaginationControl</a></li><li><a href="global.html#UploadFileForm">UploadFileForm</a></li><li><a href="global.html#appendSheetFromData">appendSheetFromData</a></li><li><a href="global.html#convertToWebP">convertToWebP</a></li><li><a href="global.html#createCustomFormModel">createCustomFormModel</a></li><li><a href="global.html#createFormFieldModel">createFormFieldModel</a></li><li><a href="global.html#createFormFieldsModel">createFormFieldsModel</a></li><li><a href="global.html#createPaymentForPartner">createPaymentForPartner</a></li><li><a href="global.html#exportAllPartnersToExcel">exportAllPartnersToExcel</a></li><li><a href="global.html#exportPartnerToExcel">exportPartnerToExcel</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatDateForUI">formatDateForUI</a></li><li><a href="global.html#getActiveSeason">getActiveSeason</a></li><li><a href="global.html#getAllApprovedPartnersWithPayments">getAllApprovedPartnersWithPayments</a></li><li><a href="global.html#getAllPartnerPayments">getAllPartnerPayments</a></li><li><a href="global.html#getAllSeasons">getAllSeasons</a></li><li><a href="global.html#getApprovedPartners">getApprovedPartners</a></li><li><a href="global.html#getMostRecentPayment">getMostRecentPayment</a></li><li><a href="global.html#getPartnerPaymentHistory">getPartnerPaymentHistory</a></li><li><a href="global.html#getPartnerPaymentsByStatus">getPartnerPaymentsByStatus</a></li><li><a href="global.html#getPartnerPaymentsForSeason">getPartnerPaymentsForSeason</a></li><li><a href="global.html#getStatusClass">getStatusClass</a></li><li><a href="global.html#getStatusInfo">getStatusInfo</a></li><li><a href="global.html#getStatusText">getStatusText</a></li><li><a href="global.html#isValidSpanishIban">isValidSpanishIban</a></li><li><a href="global.html#listenPartnerPaymentForSeason">listenPartnerPaymentForSeason</a></li><li><a href="global.html#listenPartnerPaymentHistory">listenPartnerPaymentHistory</a></li><li><a href="global.html#maskIban">maskIban</a></li><li><a href="global.html#normalizePaymentDates">normalizePaymentDates</a></li><li><a href="global.html#processFile">processFile</a></li><li><a href="global.html#sanitizeInput">sanitizeInput</a></li><li><a href="global.html#showPopup">showPopup</a></li><li><a href="global.html#updatePartnerPayment">updatePartnerPayment</a></li><li><a href="global.html#useChangeTracker">useChangeTracker</a></li><li><a href="global.html#useEvents">useEvents</a></li><li><a href="global.html#useFetchUsers">useFetchUsers</a></li><li><a href="global.html#useGallery">useGallery</a></li><li><a href="global.html#usePointerAnimation">usePointerAnimation</a></li><li><a href="global.html#useSearchFilter">useSearchFilter</a></li><li><a href="global.html#useSlug">useSlug</a></li><li><a href="global.html#useSortItems">useSortItems</a></li><li><a href="global.html#useStaffMembers">useStaffMembers</a></li><li><a href="global.html#useTaggedImage">useTaggedImage</a></li><li><a href="global.html#validateFile">validateFile</a></li><li><a href="global.html#wait">wait</a></li><li><a href="global.html#withRetry">withRetry</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Wed Dec 03 2025 20:58:54 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
